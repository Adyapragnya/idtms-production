import{r as d,j as e,o as R}from"./index-CLNSMZLW.js";/* empty css                   */import{s as p}from"./sweetalert.min-DiFPS6I4.js";import{B as N,A,M as F,a as q,b as B,c as L}from"./Modal-Dv45EkXD.js";import{a as $}from"./axios-CCb-kr4I.js";import{F as k,f as M,a as V}from"./index-CjlhgdOE.js";import{C as _,a as z}from"./CCardBody-CfTsVxOj.js";import{C as H}from"./CCardHeader-DTDcNGzu.js";import{C as G}from"./CForm-C4b5e9R_.js";import{C as i}from"./CCol-B1-P30fP.js";import{C as x}from"./CFormInput-tclTmhjH.js";import{C as U}from"./CFormSelect-Bci_q2OS.js";import{C as J}from"./CFormTextarea-ONSJIHKI.js";import{a as O}from"./index.esm-DtmDK9am.js";import"./index-DAjb0mx0.js";import"./CFormControlWrapper-xxYQpUFA.js";import"./CFormControlValidation-CHapmSMf.js";import"./CFormLabel-DPrUA8EZ.js";const Y=({title:v,documentId:T,onFilesChange:j})=>{const[n,c]=d.useState(""),[h,C]=d.useState([]),[g,f]=d.useState(!1),[b,l]=d.useState(null),D=o=>{const t=o.target.files[0],s=["image/jpeg","image/png","application/pdf"],r=5*1024*1024;t&&(s.includes(t.type)?t.size>r?p("File too large","Please upload a file smaller than 5 MB","error"):(l(t),c(t.name)):p("Invalid file type","Please upload a valid file (JPEG, PNG, PDF)","error"))},w=async()=>{const o=new FormData;o.append("file",b),o.append("formattedFileName",n);try{const s=await $.post("http://localhost:5000/api/upload-file",o,{headers:{"Content-Type":"multipart/form-data"}});console.log("Response:",s.data);const r=[...h,{formattedFileName:s.data.fileName,file:b,filePath:s.data.filePath}];C(r),j(r),l(null),c(""),f(!1)}catch(t){console.error("Error uploading file:",t)}},a=o=>{o.filePath?window.open(`http://localhost:5000/uploads/${o.filePath}`,"_blank"):console.error("File path is undefined.")},u=o=>{p({title:"Are you sure?",text:"Once deleted, you will not be able to recover this file!",icon:"warning",buttons:!0,dangerMode:!0}).then(t=>{if(t){const s=h.filter(r=>r.formattedFileName!==o);C(s),j(s),p("Your file has been deleted!",{icon:"success"})}else p("Your file is safe!")})};return e.jsxs("div",{className:"container mt-4",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center mb-4",children:[e.jsx("h5",{className:"mb-0",children:v}),e.jsxs(N,{onClick:()=>f(!0),variant:"outline-primary",className:"d-flex align-items-center",children:[e.jsx(A,{size:24,className:"me-2"}),"Add File"]})]}),e.jsxs(F,{show:g,onHide:()=>f(!1),centered:!0,children:[e.jsx(F.Header,{children:e.jsx(F.Title,{children:"Upload File"})}),e.jsx(F.Body,{children:e.jsxs("div",{className:"d-flex flex-column align-items-center",children:[e.jsx("input",{type:"text",className:"form-control mb-3",placeholder:"Enter File Name",value:n,onChange:o=>c(o.target.value)}),e.jsx("input",{type:"file",id:"file-upload",className:"d-none",onChange:D}),e.jsxs(N,{onClick:()=>document.getElementById("file-upload").click(),variant:"primary",className:"mb-3",children:[e.jsx(q,{className:"me-2"})," Choose File"]}),e.jsx(N,{onClick:w,variant:"success",children:"Upload"})]})})]}),e.jsxs("table",{className:"table table-bordered",children:[e.jsx("thead",{className:"thead-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"File Name"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:h.map((o,t)=>e.jsxs("tr",{children:[e.jsx("td",{children:o.formattedFileName}),e.jsxs("td",{children:[e.jsxs(N,{variant:"outline-success",className:"me-2",onClick:()=>a(o),children:[e.jsx(B,{})," View"]}),e.jsxs(N,{variant:"outline-danger",onClick:()=>u(o.formattedFileName),children:[e.jsx(L,{})," Delete"]})]})]},t))})]})]})},pe=()=>{const v=R(),[T,j]=d.useState(!1),[n,c]=d.useState({documentId:"",documentType:"",documentName:"",description:"",belongsTo:"",contactNo:"",dateOfUpload:"",reason:"",purpose:""}),[h,C]=d.useState([]),[g,f]=d.useState([]);d.useEffect(()=>{const a=new Date().toISOString().split("T")[0];c(t=>({...t,dateOfUpload:a}));const u=async()=>{try{const s=await fetch("http://localhost:5000/api/get-customers");if(!s.ok)throw new Error("Network response was not ok");const r=await s.json();console.log("Fetched customers:",r),C(r)}catch(t){console.error("Error fetching customers:",t)}},o=async()=>{try{const s=await fetch("http://localhost:5000/api/last-document-id");if(!s.ok)throw new Error("Network response was not ok");const r=await s.json(),S=`DOC_${(parseInt(r.lastDocumentID.split("_")[1],10)+1).toString().padStart(3,"0")}`;c(I=>({...I,documentId:S}))}catch(t){console.error("Error fetching last document ID:",t)}};u(),o()},[]);const b=async a=>{if(a.preventDefault(),a.currentTarget.checkValidity()===!1)a.stopPropagation();else try{console.log("Form data before submission:",{...n,filePaths:g.map(m=>m.filePath)});const o="http://localhost:5000",t=await fetch(`${o}/api/documents`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...n,filePaths:g.map(m=>m.filePath)})});if(!t.ok){const m=await t.json();throw new Error(m.message||"Failed to store document")}const s=await t.json();console.log("Response from storing document:",s);const r=g.map(async m=>{const y=new FormData;y.append("file",m.file),y.append("formattedFileName",m.formattedFileName),y.append("documentId",n.documentId),y.append("status","pending");const P=await fetch(`${o}/api/upload-docfile`,{method:"POST",body:y});if(!P.ok){const E=await P.json();throw new Error(`Upload failed: ${E.message||"Unknown error"}`)}return P.json()}),S=await Promise.all(r),I={...s,propertyDocuments:S};console.log("Final data to be sent to server:",I),p("Document Stored successfully!","","success"),v("/viewdocuments"),w()}catch(o){console.error("Error:",o),p("An error occurred",o.message||"Error while storing the document","error")}j(!0)},l=a=>{const{id:u,value:o}=a.target;if(c(t=>({...t,[u]:o})),u==="belongsTo"){const t=h.find(s=>s.customerName===o);t&&c(s=>({...s,contactNo:t.primaryPhone||""}))}},D=a=>{f(a)},w=()=>{const a=new Date().toISOString().split("T")[0];c({documentId:"",documentType:"",documentName:"",description:"",belongsTo:"",contactNo:"",dateOfUpload:a,reason:"",purpose:""}),f([]),j(!1)};return e.jsx("div",{className:"",children:e.jsxs(_,{className:"m-lg-4 m-xl-4",children:[e.jsx(H,{className:"text-center",children:e.jsx("h4",{className:"text-info",children:"Store Document"})}),e.jsx(z,{className:"m-lg-4 m-xl-4",children:e.jsxs(G,{className:"row g-3 needs-validation",noValidate:!0,validated:T,onSubmit:b,children:[e.jsx(i,{md:6,children:e.jsx(x,{type:"text",id:"documentId",label:"Document ID",required:!0,disabled:!0,value:n.documentId,readOnly:!0})}),e.jsx(i,{md:6,children:e.jsx(x,{type:"date",id:"dateOfUpload",label:"Date of Upload",required:!0,disabled:!0,value:n.dateOfUpload,onChange:l})}),e.jsx(i,{md:6,children:e.jsxs(U,{id:"documentType",label:"Document Type",required:!0,value:n.documentType,onChange:l,children:[e.jsx("option",{value:"",children:"Select Type"}),e.jsx("option",{value:"Invoice",children:"Invoice"}),e.jsx("option",{value:"Receipt",children:"Receipt"}),e.jsx("option",{value:"Property Document",children:"Property Document"}),e.jsx("option",{value:"Others",children:"Others"})]})}),e.jsx(i,{md:6,children:e.jsx(x,{type:"text",id:"documentName",label:"Document Name",required:!0,value:n.documentName,onChange:l})}),e.jsx(i,{md:6,children:e.jsxs(U,{id:"belongsTo",label:"Belongs To",required:!0,value:n.belongsTo,onChange:l,children:[e.jsx("option",{value:"",children:"Select Customer"}),h.map(a=>e.jsx("option",{value:a.customerName,children:a.customerName},a._id))]})}),e.jsx(i,{md:6,children:e.jsx(x,{type:"number",id:"contactNo",label:"Contact Number",required:!0,value:n.contactNo,onChange:l})}),e.jsx(i,{md:12,children:e.jsx(J,{id:"description",label:"Description",required:!0,value:n.description,onChange:l})}),e.jsx(i,{md:6,children:e.jsx(x,{type:"text",id:"reason",label:"Reason",required:!0,value:n.reason,onChange:l})}),e.jsx(i,{md:6,children:e.jsx(x,{type:"text",id:"purpose",label:"Purpose",required:!0,value:n.purpose,onChange:l})}),e.jsx(i,{md:12,children:e.jsx("hr",{})}),e.jsx(Y,{title:"Property Documents",documentId:n.documentId,onFilesChange:D}),e.jsxs(i,{xs:12,className:"d-flex justify-content-center",children:[e.jsxs(O,{type:"submit",color:"primary",className:"me-2",children:["  ",e.jsx(k,{icon:M,className:"text-white"})," Submit"]}),e.jsxs(O,{type:"button",color:"secondary",onClick:w,children:["  ",e.jsx(k,{icon:V,className:"text-white"})," Cancel"]})]})]})})]})})};export{pe as default};
